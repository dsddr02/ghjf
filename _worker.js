import{connect}from"cloudflare:sockets";let å“å‘€å‘€è¿™æ˜¯æˆ‘çš„IDå•Š="112211",å“å‘€å‘€è¿™æ˜¯æˆ‘çš„VLå¯†é’¥="2b15c85b-a08f-4efc-886a-4dfaa99ea8b4",ç§é’¥å¼€å…³=!1,å’¦è¿™æ˜¯æˆ‘çš„ç§é’¥å“="",éšè—è®¢é˜…=!0,å˜²è®½è¯­="å“å‘€ä½ æ‰¾åˆ°äº†æˆ‘ï¼Œä½†æ˜¯æˆ‘å°±æ˜¯ä¸ç»™ä½ çœ‹ï¼Œæ°”ä¸æ°”ï¼Œå˜¿å˜¿å˜¿",æˆ‘çš„ä¼˜é€‰=["www.visa.com"],æˆ‘çš„ä¼˜é€‰TXT="https://raw.githubusercontent.com/TgDaosheng/Cloudflare-Trojan/main/ipv4.txt",å¯ç”¨åä»£åŠŸèƒ½=!0,åä»£IP="ts.hpc.tw",å¯ç”¨SOCKS5åä»£=!1,å¯ç”¨SOCKS5å…¨å±€åä»£=!1,æˆ‘çš„SOCKS5è´¦å·="",æˆ‘çš„èŠ‚ç‚¹åå­—="å¤©ä¹¦",ä¼ªè£…ç½‘é¡µ="www.youku.com",å¯ç”¨æœ¬åœ°ç¼“å­˜=!0,TCPå¹¶å‘æ•°=1,é™é€Ÿç­‰çº§=0;export default{async fetch(e,t){const n=e.headers.get("Upgrade"),a=new URL(e.url);if(n&&"websocket"===n){if("websocket"===n){if(åä»£IP=t.PROXYIP||åä»£IP,æˆ‘çš„SOCKS5è´¦å·=t.SOCKS5||æˆ‘çš„SOCKS5è´¦å·,å¯ç”¨SOCKS5åä»£="true"===t.SOCKS5OPEN||"false"!==t.SOCKS5OPEN&&å¯ç”¨SOCKS5åä»£,å¯ç”¨SOCKS5å…¨å±€åä»£="true"===t.SOCKS5GLOBAL||"false"!==t.SOCKS5GLOBAL&&å¯ç”¨SOCKS5å…¨å±€åä»£,!ç§é’¥å¼€å…³)return await å‡çº§WSè¯·æ±‚(e);if(e.headers.get("my-key")===å’¦è¿™æ˜¯æˆ‘çš„ç§é’¥å“)return await å‡çº§WSè¯·æ±‚(e)}}else{if(æˆ‘çš„ä¼˜é€‰TXT){const e=await fetch(æˆ‘çš„ä¼˜é€‰TXT),t=(await e.text()).split("\n").map((e=>e.trim())).filter((e=>e));æˆ‘çš„ä¼˜é€‰=t||æˆ‘çš„ä¼˜é€‰}switch(a.pathname){case`/${å“å‘€å‘€è¿™æ˜¯æˆ‘çš„IDå•Š}`:{const t=ç»™æˆ‘è®¢é˜…é¡µé¢(å“å‘€å‘€è¿™æ˜¯æˆ‘çš„IDå•Š,e.headers.get("Host"));return new Response(`${t}`,{status:200,headers:{"Content-Type":"text/plain;charset=utf-8"}})}case`/${å“å‘€å‘€è¿™æ˜¯æˆ‘çš„IDå•Š}/${è½¬ç }${è½¬ç 2}`:if(éšè—è®¢é˜…)return new Response(`${å˜²è®½è¯­}`,{status:200,headers:{"Content-Type":"text/plain;charset=utf-8"}});{const t=ç»™æˆ‘é€šç”¨é…ç½®æ–‡ä»¶(e.headers.get("Host"));return new Response(`${t}`,{status:200,headers:{"Content-Type":"text/plain;charset=utf-8"}})}case`/${å“å‘€å‘€è¿™æ˜¯æˆ‘çš„IDå•Š}/${å°çŒ«}${å’ª}`:if(éšè—è®¢é˜…)return new Response(`${å˜²è®½è¯­}`,{status:200,headers:{"Content-Type":"text/plain;charset=utf-8"}});{const t=ç»™æˆ‘å°çŒ«å’ªé…ç½®æ–‡ä»¶(e.headers.get("Host"));return new Response(`${t}`,{status:200,headers:{"Content-Type":"text/plain;charset=utf-8"}})}default:return a.hostname=ä¼ªè£…ç½‘é¡µ,a.protocol="https:",e=new Request(a,e),fetch(e)}}}};async function å‡çº§WSè¯·æ±‚(e){const t=new WebSocketPair,[n,a]=Object.values(t);a.accept();const s=ä½¿ç”¨64ä½åŠ è§£å¯†(e.headers.get("sec-websocket-protocol")),{"TCPæ¥å£":r,"å†™å…¥åˆå§‹æ•°æ®":o}=await è§£æVLæ ‡å¤´(s);return å»ºç«‹ä¼ è¾“ç®¡é“(a,r,o),new Response(null,{status:101,webSocket:n})}function ä½¿ç”¨64ä½åŠ è§£å¯†(e){e=e.replace(/-/g,"+").replace(/_/g,"/");const t=atob(e);return Uint8Array.from(t,(e=>e.charCodeAt(0))).buffer}async function è§£æVLæ ‡å¤´(e,t){if(!ç§é’¥å¼€å…³&&éªŒè¯VLçš„å¯†é’¥(new Uint8Array(e.slice(1,17)))!==å“å‘€å‘€è¿™æ˜¯æˆ‘çš„VLå¯†é’¥)return null;const n=18+new Uint8Array(e)[17]+1,a=e.slice(n,n+2),s=new DataView(a).getUint16(0),r=n+2,o=new Uint8Array(e.slice(r,r+1))[0];let i=0,c="",l=r+1;switch(o){case 1:i=4,c=new Uint8Array(e.slice(l,l+i)).join(".");break;case 2:i=new Uint8Array(e.slice(l,l+1))[0],l+=1,c=(new TextDecoder).decode(e.slice(l,l+i));break;case 3:i=16;const t=new DataView(e.slice(l,l+i)),n=[];for(let e=0;e<8;e++)n.push(t.getUint16(2*e).toString(16));c=n.join(":")}const p=e.slice(l+i);if(å¯ç”¨åä»£åŠŸèƒ½&&å¯ç”¨SOCKS5åä»£&&å¯ç”¨SOCKS5å…¨å±€åä»£)return{"TCPæ¥å£":t=await åˆ›å»ºSOCKS5æ¥å£(o,c,s),"å†™å…¥åˆå§‹æ•°æ®":p};try{t=connect({hostname:c,port:s}),await t.opened}catch{if(å¯ç”¨åä»£åŠŸèƒ½)if(å¯ç”¨SOCKS5åä»£)t=await åˆ›å»ºSOCKS5æ¥å£(o,c,s);else{let[e,n]=åä»£IP.split(":");t=connect({hostname:e,port:n||s})}}finally{return{"TCPæ¥å£":t,"å†™å…¥åˆå§‹æ•°æ®":p}}}function éªŒè¯VLçš„å¯†é’¥(e,t=0){return(è½¬æ¢å¯†é’¥æ ¼å¼[e[t+0]]+è½¬æ¢å¯†é’¥æ ¼å¼[e[t+1]]+è½¬æ¢å¯†é’¥æ ¼å¼[e[t+2]]+è½¬æ¢å¯†é’¥æ ¼å¼[e[t+3]]+"-"+è½¬æ¢å¯†é’¥æ ¼å¼[e[t+4]]+è½¬æ¢å¯†é’¥æ ¼å¼[e[t+5]]+"-"+è½¬æ¢å¯†é’¥æ ¼å¼[e[t+6]]+è½¬æ¢å¯†é’¥æ ¼å¼[e[t+7]]+"-"+è½¬æ¢å¯†é’¥æ ¼å¼[e[t+8]]+è½¬æ¢å¯†é’¥æ ¼å¼[e[t+9]]+"-"+è½¬æ¢å¯†é’¥æ ¼å¼[e[t+10]]+è½¬æ¢å¯†é’¥æ ¼å¼[e[t+11]]+è½¬æ¢å¯†é’¥æ ¼å¼[e[t+12]]+è½¬æ¢å¯†é’¥æ ¼å¼[e[t+13]]+è½¬æ¢å¯†é’¥æ ¼å¼[e[t+14]]+è½¬æ¢å¯†é’¥æ ¼å¼[e[t+15]]).toLowerCase()}const è½¬æ¢å¯†é’¥æ ¼å¼=[];for(let e=0;e<256;++e)è½¬æ¢å¯†é’¥æ ¼å¼.push((e+256).toString(16).slice(1));async function å»ºç«‹ä¼ è¾“ç®¡é“(e,t,n,a=[],s=[]){await e.send(new Uint8Array([0,0]).buffer);const r=new ReadableStream({async start(a){n&&a.enqueue(n),e.addEventListener("message",(e=>{a.enqueue(e.data)})),e.addEventListener("close",(()=>{a.close(),t.close(),setTimeout((()=>e.close(1e3)),2)})),e.addEventListener("error",(()=>{a.close(),t.close(),setTimeout((()=>e.close(1001)),2)}))}});Promise.allSettled(Array.from({length:TCPå¹¶å‘æ•°},(()=>r.pipeTo(new WritableStream({async write(e){const n=t.writable.getWriter();if(å¯ç”¨æœ¬åœ°ç¼“å­˜){await a.push(e);let t=a.shift();await n.write(t)}else await n.write(e);n.releaseLock(),await new Promise((e=>setTimeout(e,é™é€Ÿç­‰çº§)))}}))))),t.readable.pipeTo(new WritableStream({async write(t){if(å¯ç”¨æœ¬åœ°ç¼“å­˜){await s.push(t);let n=s.shift();await e.send(n)}else await e.send(t);await new Promise((e=>setTimeout(e,é™é€Ÿç­‰çº§)))}}))}async function åˆ›å»ºSOCKS5æ¥å£(e,t,n){const{username:a,password:s,hostname:r,port:o}=await è·å–SOCKS5è´¦å·(æˆ‘çš„SOCKS5è´¦å·),i=connect({hostname:r,port:o});try{await i.opened}catch{return new Response("SOCKS5æœªè¿é€š",{status:400})}const c=i.writable.getWriter(),l=i.readable.getReader(),p=new TextEncoder,u=new Uint8Array([5,2,0,2]);await c.write(u);let w,f=(await l.read()).value;if(2===f[1]){if(!a||!s)return å…³é—­æ¥å£å¹¶é€€å‡º();const e=new Uint8Array([1,a.length,...p.encode(a),s.length,...p.encode(s)]);if(await c.write(e),f=(await l.read()).value,1!==f[0]||0!==f[1])return å…³é—­æ¥å£å¹¶é€€å‡º()}switch(e){case 1:w=new Uint8Array([1,...t.split(".").map(Number)]);break;case 2:w=new Uint8Array([3,t.length,...p.encode(t)]);break;case 3:w=new Uint8Array([4,...t.split(":").flatMap((e=>[parseInt(e.slice(0,2),16),parseInt(e.slice(2),16)]))]);break;default:return å…³é—­æ¥å£å¹¶é€€å‡º()}const S=new Uint8Array([5,1,0,...w,n>>8,255&n]);return await c.write(S),f=(await l.read()).value,5!==f[0]||0!==f[1]?å…³é—­æ¥å£å¹¶é€€å‡º():(c.releaseLock(),l.releaseLock(),i);function å…³é—­æ¥å£å¹¶é€€å‡º(){return c.releaseLock(),l.releaseLock(),i.close(),new Response("SOCKS5æ¡æ‰‹å¤±è´¥",{status:400})}}async function è·å–SOCKS5è´¦å·(e){const[t,n]=e.split("@").reverse();let a,s,r,o;if(n){const e=n.split(":");a=e[0],s=e[1]}const i=t.split(":");return o=Number(i.pop()),r=i.join(":"),{username:a,password:s,hostname:r,port:o}}let æˆ‘çš„ç§é’¥,è½¬ç ="vl",è½¬ç 2="ess",ç¬¦å·="://",å°çŒ«="cla",å’ª="sh";function ç»™æˆ‘è®¢é˜…é¡µé¢(e,t){return`\n1ã€æœ¬workerçš„ç§é’¥åŠŸèƒ½åªæ”¯æŒ${å°çŒ«}${å’ª}ï¼Œä»…open${å°çŒ«}${å’ª}å’Œ${å°çŒ«}${å’ª} metaæµ‹è¯•è¿‡ï¼Œå…¶ä»–${å°çŒ«}${å’ª}ç±»è½¯ä»¶è‡ªè¡Œæµ‹è¯•\n2ã€è‹¥ä½¿ç”¨é€šç”¨è®¢é˜…è¯·å…³é—­ç§é’¥åŠŸèƒ½\n3ã€å…¶ä»–éœ€æ±‚è‡ªè¡Œç ”ç©¶\né€šç”¨çš„ï¼šhttps${ç¬¦å·}${t}/${e}/${è½¬ç }${è½¬ç 2}\nçŒ«å’ªçš„ï¼šhttps${ç¬¦å·}${t}/${e}/${å°çŒ«}${å’ª}\n`}function ç»™æˆ‘é€šç”¨é…ç½®æ–‡ä»¶(e){return 0===æˆ‘çš„ä¼˜é€‰.length&&(æˆ‘çš„ä¼˜é€‰=[`${e}:443`]),ç§é’¥å¼€å…³?"è¯·å…ˆå…³é—­ç§é’¥åŠŸèƒ½":æˆ‘çš„ä¼˜é€‰.map((t=>{const[n,a]=t.split("@"),[s,r=æˆ‘çš„èŠ‚ç‚¹åå­—]=n.split("#"),o=s.split(":"),i=o.length>1?Number(o.pop()):443,c=o.join(":");return`${è½¬ç }${è½¬ç 2}${ç¬¦å·}${å“å‘€å‘€è¿™æ˜¯æˆ‘çš„VLå¯†é’¥}@${c}:${i}?encryption=none&${"notls"===a?"security=none":"security=tls"}&sni=${e}&type=ws&host=${e}&path=%2F%3Fed%3D2560#${r}`})).join("\n")}function ç»™æˆ‘å°çŒ«å’ªé…ç½®æ–‡ä»¶(e){0===æˆ‘çš„ä¼˜é€‰.length&&(æˆ‘çš„ä¼˜é€‰=[`${e}:443`]);const ç”ŸæˆèŠ‚ç‚¹=t=>t.map((t=>{const[n,a]=t.split("@"),[s,r=æˆ‘çš„èŠ‚ç‚¹åå­—]=n.split("#"),o=s.split(":"),i=o.length>1?Number(o.pop()):443,c=o.join(":").replace(/^\[(.+)\]$/,"$1");return{nodeConfig:`- name: ${r}-${c}-${i}\n  type: ${è½¬ç }${è½¬ç 2}\n  server: ${c}\n  port: ${i}\n  uuid: ${å“å‘€å‘€è¿™æ˜¯æˆ‘çš„VLå¯†é’¥}\n  udp: false\n  tls: ${"notls"===a?"false":"true"}\n  sni: ${e}\n  network: ws\n  ws-opts:\n    path: "/?ed=2560"\n    headers:\n      Host: ${e}\n      ${æˆ‘çš„ç§é’¥}`,proxyConfig:`    - ${r}-${c}-${i}`}})),t=ç”ŸæˆèŠ‚ç‚¹(æˆ‘çš„ä¼˜é€‰).map((e=>e.nodeConfig)).join("\n"),n=ç”ŸæˆèŠ‚ç‚¹(æˆ‘çš„ä¼˜é€‰).map((e=>e.proxyConfig)).join("\n");return`\ndns:\n  nameserver:\n    - 180.76.76.76\n    - 2400:da00::6666\n  fallback:\n    - 8.8.8.8\n    - 2001:4860:4860::8888\nproxies:\n${t}\nproxy-groups:\n- name: ğŸš€ èŠ‚ç‚¹é€‰æ‹©\n  type: select\n  proxies:\n    - è‡ªåŠ¨é€‰æ‹©\n${n}\n- name: è‡ªåŠ¨é€‰æ‹©\n  type: url-test\n  url: http://www.gstatic.com/generate_204\n  interval: 60 #æµ‹è¯•é—´éš”\n  tolerance: 30\n  proxies:\n${n}\n- name: æ¼ç½‘ä¹‹é±¼\n  type: select\n  proxies:\n    - DIRECT\n    - ğŸš€ èŠ‚ç‚¹é€‰æ‹©\nrules: # æœ¬äººè‡ªç”¨è§„åˆ™ï¼Œä¸ä¸€å®šé€‚åˆæ‰€æœ‰äººæ‰€æœ‰å®¢æˆ·ç«¯ï¼Œå¦‚å®¢æˆ·ç«¯å› è§„åˆ™é—®é¢˜æ— æ³•è®¢é˜…å°±åˆ é™¤å¯¹åº”è§„åˆ™å§ï¼Œæ¯ä¸ªäººéƒ½æœ‰è‡ªå·±ä¹ æƒ¯çš„è§„åˆ™ï¼Œè‡ªè¡Œç ”ç©¶å“¦\n# ç­–ç•¥è§„åˆ™ï¼Œå»ºè®®ä½¿ç”¨metaå†…æ ¸ï¼Œéƒ¨åˆ†è§„åˆ™éœ€æ‰“å¼€${å°çŒ«}${å’ª} mateçš„ä½¿ç”¨geoip datç‰ˆæ•°æ®åº“ï¼Œæ¯”å¦‚TGè§„åˆ™å°±éœ€è¦ï¼Œæˆ–è€…è‡ªå®šä¹‰geoipçš„è§„åˆ™è®¢é˜…\n# è¿™æ˜¯geoipçš„è§„åˆ™è®¢é˜…é“¾æ¥ï¼Œhttps://cdn.jsdelivr.net/gh/Loyalsoldier/geoip@release/Country.mmdb\n# - GEOSITE,category-ads-all,REJECT #ç®€å•å¹¿å‘Šè¿‡æ»¤è§„åˆ™ï¼Œè¦å¢åŠ è§„åˆ™æ•°å¯ä½¿ç”¨category-ads-all\n- GEOSITE,cn,DIRECT #å›½å†…åŸŸåç›´è¿è§„åˆ™\n- GEOIP,CN,DIRECT,no-resolve #å›½å†…IPç›´è¿è§„åˆ™\n- GEOSITE,cloudflare,DIRECT #CFåŸŸåç›´è¿è§„åˆ™\n- GEOIP,CLOUDFLARE,DIRECT,no-resolve #CFIPç›´è¿è§„åˆ™\n- GEOSITE,gfw,ğŸš€ èŠ‚ç‚¹é€‰æ‹© #GFWåŸŸåè§„åˆ™\n- GEOSITE,google,ğŸš€ èŠ‚ç‚¹é€‰æ‹© #GOOGLEåŸŸåè§„åˆ™\n- GEOIP,GOOGLE,ğŸš€ èŠ‚ç‚¹é€‰æ‹©,no-resolve #GOOGLE IPè§„åˆ™\n- GEOSITE,netflix,ğŸš€ èŠ‚ç‚¹é€‰æ‹© #å¥ˆé£åŸŸåè§„åˆ™\n- GEOIP,NETFLIX,ğŸš€ èŠ‚ç‚¹é€‰æ‹©,no-resolve #å¥ˆé£IPè§„åˆ™\n- GEOSITE,telegram,ğŸš€ èŠ‚ç‚¹é€‰æ‹© #TGåŸŸåè§„åˆ™\n- GEOIP,TELEGRAM,ğŸš€ èŠ‚ç‚¹é€‰æ‹©,no-resolve #TG IPè§„åˆ™\n- GEOSITE,openai,ğŸš€ èŠ‚ç‚¹é€‰æ‹© #GPTè§„åˆ™\n- MATCH,æ¼ç½‘ä¹‹é±¼\n  `}æˆ‘çš„ç§é’¥=ç§é’¥å¼€å…³?`my-key: ${å’¦è¿™æ˜¯æˆ‘çš„ç§é’¥å“}`:"";
